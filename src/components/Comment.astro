---
import config from "$config";
---

<section id="comment" class="w-full"></section>

<script is:inline>
	// Function to get the current theme for utterances
	const getUtterancesTheme = () => {
		return document.documentElement.dataset.theme === "dark" ? "github-dark" : "github-light";
	};

	// 1. Set initial theme directly on the script tag for reliability on first load.
	const script = document.createElement("script");
	script.src = "https://utteranc.es/client.js";
	script.setAttribute("repo", "xxxkjing/giscus-comment");
	script.setAttribute("issue-term", "og:title");
	script.setAttribute("label", "ðŸ’¬è¯„è®º");
	script.setAttribute("theme", getUtterancesTheme()); // Set initial theme
	script.setAttribute("crossorigin", "anonymous");
	script.async = true;
	document.querySelector("#comment").appendChild(script);

	// 2. Use postMessage for dynamic theme changes (after site theme switch or login).
	const postThemeMessage = () => {
		const message = {
			type: "set-theme",
			theme: getUtterancesTheme(),
		};
		const utterances = document.querySelector(".utterances-frame");
		if (utterances instanceof HTMLIFrameElement && utterances.contentWindow) {
			utterances.contentWindow.postMessage(message, "https://utteranc.es");
		}
	};

	// Use a longer timeout to ensure the iframe is ready to receive the message.
	const delayedPostTheme = () => setTimeout(postThemeMessage, 1000);

	const commentSection = document.querySelector("#comment");
	if (commentSection) {
		// Observe when the iframe is added to the DOM
		const observer = new MutationObserver(() => {
			const utterancesFrame = document.querySelector(".utterances-frame");
			if (utterancesFrame instanceof HTMLIFrameElement) {
				// The 'load' event fires when iframe content (re)loads, e.g., after login.
				// We use a timeout to wait for scripts inside the iframe to initialize.
				utterancesFrame.addEventListener("load", delayedPostTheme);
				observer.disconnect(); // Found it, no need to observe anymore.
			}
		});
		observer.observe(commentSection, { childList: true });
	}

	// Observe data-theme attribute changes on the root element for site theme switches.
	const themeObserver = new MutationObserver(delayedPostTheme);
	themeObserver.observe(document.documentElement, {
		attributes: true,
		attributeFilter: ["data-theme"],
	});
</script>