---
import { getCollection, render } from "astro:content";
import config from "$config";
import logo from "$icons/site-logo.png";
import Time from "$utils/time";
import Base from "$layouts/Base.astro";
import Heatmap from "$components/Heatmap.svelte";
import { getHomeSEO, getWebSiteSchema } from "$utils/seo";

// 生成首页 SEO 配置
const seoConfig = getHomeSEO(Astro.site!);

// 生成网站结构化数据
const websiteSchema = getWebSiteSchema(Astro.site!);

// Get preface content for current locale, sorted by timestamp (latest first)
const prefaces = (
	await getCollection("preface", preface => {
		// Extract language and ID from file path structure
		const [language, id] = preface.id.split("/");
		preface.id = id;

		// Filter by current locale
		return language === "zh-cn";
	})
).sort((a, b) => b.data.timestamp.getTime() - a.data.timestamp.getTime());

// Get published notes for current locale
const notes = await getCollection("note", note => {
	// Assign type property
	Reflect.set(note, "type", "note");

	// Filter by publication status and locale
	let published = !note.data.draft;
	let localed = note.id.split("/")[0] === "zh-cn";

	// Filter published notes by current locale
	return published && localed;
});

// Get published jottings for current locale
const jottings = await getCollection("jotting", jotting => {
	// Assign type property
	Reflect.set(jotting, "type", "jotting");

	// Check monolocale setup or extract language to match locale
	let localed = jotting.id.split("/")[0] === "zh-cn";

	// Filter published notes by current locale
	return !jotting.data.draft && localed;
});

// Combine contents
let items: { id: string; type?: string; data: { timestamp: Date; tags?: string[]; [key: string]: any } }[] = [];

// Determine which sections to include
const sections = config.latest || "*";

// Add contents based on config
if (sections === "*" || sections.includes("note")) items = items.concat(notes);
if (sections === "*" || sections.includes("jotting")) items = items.concat(jottings);

// Get the latest content for display
const latest = items.sort((a, b) => b.data.timestamp.getTime() - a.data.timestamp.getTime())[0];

// Get the latest preface for display
const preface = prefaces[0];
// Render preface content if available, otherwise use empty object
const { Content } = preface ? await render(preface) : ({} as any);
---

<Base title="首页" seoConfig={seoConfig}>
	<script type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />
	<main class="flex flex-col gap-5 sm:gap-20 flex-grow">
		<header class="flex items-center justify-center flex-wrap-reverse grow-0.6">
			{config.prologue && <article class="mr-a font-cursive font-thin text-size-xl sm:text-size-2xl line-height-loose whitespace-pre-line">{config.prologue}</article>}
			<img src={logo.src} alt="Site Logo" width="100" height="100" />
		</header>

		{
			preface && (
				<section class="flex flex-col">
					<article class="markdown">
						<Content />
					</article>
					<a href="/preface" class="self-end my-2 text-size-sm c-secondary">
						—— {Time.date.locale(preface.data.timestamp, "zh-cn")}
					</a>
				</section>
			)
		}

		{
			latest && (
				<footer class="flex items-center justify-center flex-wrap-reverse gap-10">
					<Heatmap client:load {notes} {jottings} />

					<blockquote class="flex-grow">
						<h3>最新</h3>
						<div class="flex flex-col sm:flex-row justify-between gap-1 mt-2">
							<a href={`/${latest.type}/${latest.id.split("/").slice(1).join("/")}`} class="link">
								{latest.data.series && `${latest.data.series} | `}
								{latest.data.title}
							</a>
							<div class="flex gap-1">
								{latest.data.tags?.map(tag => (
									<span class="c-remark text-size-sm">#{tag}</span>
								))}
							</div>
						</div>
						<time datetime={latest.data.timestamp.toISOString()} class="c-remark font-mono text-xs">
							{Time(latest.data.timestamp)}
						</time>
					</blockquote>
				</footer>
			)
		}
	</main>
</Base>