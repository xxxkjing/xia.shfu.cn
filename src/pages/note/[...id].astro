---
import type { MarkdownHeading } from "astro";
import { getCollection, getEntry, render } from "astro:content";
import Time from "$utils/time";
import Base from "$layouts/Base.astro";
import Icon from "$components/Icon.astro";
import TOC from "$components/note/TOC.astro";
import Position from "$components/Position.astro";
import Sensitive from "$components/Sensitive.svelte";
import Comment from "$components/Comment.astro";
import { getArticleSEO, getArticleSchema, getBreadcrumbSchema } from "$utils/seo";

export async function getStaticPaths() {
	// Get all notes excluding drafts
	const notes = await getCollection("note", note => !note.data.draft);

	return notes
		.map(note => {
			// Extract language and note ID from file path structure
			const [language, ...ids] = note.id.split("/");

			if (language !== "zh-cn") return null;

			const id = ids.join("/");

			// Generate path params with optional locale (omit for default locale)
			return { params: { id }, props: { note } };
		})
		.filter(Boolean);
}

const { id } = Astro.params;
const { note: propsNote } = Astro.props;

// Re-fetch the entry to get the proper render method
const note = await getEntry("note", propsNote?.id ?? `zh-cn/${id}`);

if (!note) {
	return Astro.redirect("/404");
}

// Render markdown content and extract headings for TOC
const { Content, headings, remarkPluginFrontmatter: frontmatter } = await render(note);

// Build hierarchical table of contents from flat heading list
type Heading = MarkdownHeading & { subheadings: Heading[] };
const tableOfContents: Heading[] = [];
const stack: Heading[] = [];
for (const item of headings) {
	// Pop headings from stack that are at same or deeper level
	while (stack[stack.length - 1]?.depth >= item.depth) stack.pop();
	const heading: Heading = { ...item, subheadings: [] };

	if (stack.length > 0) {
		// Add as subheading to current parent
		const parent = stack[stack.length - 1];
		parent.subheadings.push(heading);
	} else {
		// Add as top-level heading
		tableOfContents.push(heading);
	}

	stack.push(heading);
}

// 生成 SEO 配置
const seoConfig = getArticleSEO(Astro.site!, Astro.url.pathname, note);

// 生成文章结构化数据
const articleSchema = getArticleSchema(Astro.site!, Astro.url.pathname, note);

// 生成面包屑导航
const breadcrumbSchema = getBreadcrumbSchema(Astro.site!, [
	{ name: "首页", url: "/" },
	{ name: "笔记", url: "/note" },
	{ name: note.data.title, url: Astro.url.pathname }
]);
---

<Base title={note.data.title} description={note.data.description} article={{ timestamp: note.data.timestamp, section: note.data.series, tags: note.data.tags }} seoConfig={seoConfig}>
	<script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
	<script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
	<main class="flex flex-col gap-6">
		<header class="flex flex-col gap-4">
			<h1 class="text-3xl">{note.data.title}</h1>
			<div class="flex flex-col gap-3 sm:flex-row children:(flex items-center gap-1 text-3.5 c-secondary)">
				<time datetime={note.data.timestamp.toISOString()}><Icon name="lucide:calendar" />{Time(note.data.timestamp)}</time>
				{
					note.data.series && (
						<span>
							<Icon name="lucide:layers" />
							{note.data.series}
						</span>
					)
				}
				{
					note.data.tags?.length && (
						<span>
							<Icon name="lucide:hash" />
							{note.data.tags?.join("; ")}
						</span>
					)
				}
				<span><Icon name="lucide:pilcrow" />{frontmatter.words} 字</span>
			</div>
			<hr class="b-b b-b-solid b-weak" />
		</header>

		<Sensitive back="/note" sensitive={note.data.sensitive} client:load>
			<div class="flex gap-5">
				<section id="markdown-content" class="markdown"><Content /></section>
				{
					headings.length > 0 && (
						<aside class="hidden sm:(block flex-shrink-0 w-200px)">
							<div class="sticky top-3 flex flex-col gap-2">
								<h3>目录</h3>
								<nav class="overflow-y-auto">
									<TOC headings={tableOfContents} />
								</nav>
							</div>
						</aside>
					)
				}
			</div>
		</Sensitive>

		<Position locale="zh-cn" />
		<Comment />
	</main>
</Base>